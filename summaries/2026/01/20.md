# Activity Summary for 1/20/2026

## 12:33:41 PM
The file `c:\Users\Dennis\Documents\projects\rfdregister\site\contact_tabs.php` was last modified on **1/20/2026, 11:33:31 AM**.

This PHP script is responsible for dynamically generating and populating content within tabs on a contact detail page, likely for displaying associated guns and ammunition.

**Key Updates and Functionality:**

*   **AJAX Request Handling:** The script initiates by checking for an `$_REQUEST["siajax"]` parameter. If present, it enforces an administrator sign-in check using `admin_is_signed_in()` and proceeds to populate the tab content.
*   **Dynamic Tab Configuration:** The available tabs (`$Atab`) are determined by specific client options:
    *   If `AMMOMIGRATED` or `AMMO2.0` options are enabled, three tabs are shown: "Guns" (GUN), "New Ammo" (AMMO2), and "Old Ammo" (AMMO).
    *   Otherwise, only "Guns" (GUN) and "Ammo" (AMMO) tabs are displayed. This indicates a staged rollout or legacy support for ammunition management systems.
*   **Tab-Specific Data Listing:** A `switch` statement handles the content for each tab type:
    *   **GUN Tab:** Fetches records from the `gun` table. It orders by `gun_id DESC, gun_toWeb` (with a comment suggesting this is a trick for compound indexing) and filters by `gun_user_in_id` or `gun_user_out_id` matching the contact `id`, `client_id`, and `gun_status = "OK"`. It calculates a `direction` field (IN, OUT, IN/OUT) and includes columns like `InDate`, `OutDate`, `StockNumber`, `SerialNumber`, `Type`, `Make`, `Model`, `Calibre`, and `Mechanism`. A special `gun_isGone` field adds a `gungone` CSS class to rows where `gun_outDate` is not null.
    *   **AMMO Tab (Old Ammo):** Retrieves data from the `ammo_transaction` table. It orders by `ammo_id DESC` and filters by `contact_id`, `client_id`, and `ammo_status != 'WITHDRAWN'`. Columns include `InOut` (direction), `created` (date), `description` (a concatenated field of type, calibre, and make), `model` (a concatenated field of model name, price, and head type), `Quantity`, and `Notes`.
    *   **AMMO2 Tab (New Ammo):** This tab represents a newer ammunition system. It joins the `ammunition` table with `ammunition_trans` and filters by `contactID` and `clientID` from the `ammunition_trans` table. Columns include `direction`, `ammunitionDate`, `type`, `calibre`, `make`, `model`, and `qty`.
*   **Shared Framework Components:** The script consistently includes files from the `egc/` directory: `si_tab_v7.inc`, `si_ilist_v7.inc`, and `si_ilist_v7_ajax.inc`. These files likely provide the core functionality for rendering tabs and interactive item lists.

**Patterns and Recurring Elements:**

*   **Client-Specific Features:** The use of `site_client_has_option()` for `AMMOMIGRATED` and `AMMO2.0` is a clear pattern for enabling or disabling features based on client configuration, suggesting a multi-tenant application or feature flag system.
*   **Standardized Listing Variables:** A set of `ilist_` prefixed variables (`ilist_table`, `ilist_primary_key`, `ilist_order_by`, `ilist_extra_from`, `ilist_extra_where`, `ilist_query_id`) are used consistently across different tab types to define the data source and filtering criteria for the generic item list component.
*   **Structured Column Definitions:** The `$Ailist` array is used to define the columns for each list, specifying prompts, data types (e.g., `jqcaldate`), and custom SQL `select` clauses for derived or concatenated fields.
*   **`client_id` for Data Partitioning:** All data queries include a `client_id` in their `WHERE` clauses, indicating that the system manages data for multiple clients, ensuring data isolation.
*   **Legacy vs. New System Support:** The distinction between `AMMO` and `AMMO2` tabs, along with the `AMMOMIGRATED`/`AMMO2.0` options, suggests an ongoing migration or support for both an older and newer version of an ammunition tracking system.