# Activity Summary for 10/29/2025

## 10:28:49 AM
The changes log primarily details development related to EPOS (Electronic Point of Sale) integration for contact synchronization across two PHP files: `contact.php` and `cron_epos_sync.php`. All recorded modifications occurred on October 29, 2025.

**File-Specific Updates:**

*   **`site\contact.php`**: This file, responsible for contact management in the web application, underwent several updates:
    *   Initial state (circa 9:44 AM): It provided core contact functionalities including search, insert, display, and integration with existing gun/ammo/multi-book out transactions, along with print media styling for contact pages.
    *   **Significant Change (10/29/2025, 9:47:35 AM)**: A new PHP function `queue_epos_sync($contact_id, $action = 'update')` was introduced. This function is designed to mark a contact for synchronization with an EPOS system by updating `contact_epos_sync_status` to 'pending' and resetting `contact_epos_sync_attempts` in the `contact` database table. It also included a commented-out section for an "advanced" queueing method using a separate `epos_sync_queue` table.
    *   **Refinement (10/29/2025, 9:47:45 AM)**: The commented-out code block for the "advanced" EPOS queue table was removed, streamlining the `queue_epos_sync` function to exclusively use the `contact` table's flags.
    *   **Minor Reordering (10/29/2025, 10:03:17 AM)**: The `queue_epos_sync` function's definition was reordered within the file, moving it slightly higher up.

*   **`site\cron_epos_sync.php`**: This file, introduced during these changes, functions as a background worker for EPOS synchronization.
    *   **Initial Creation (10/29/2025, 9:50:30 AM)**: The script was created, designed for command-line execution (with an optional web override). It defined constants for batch size, max attempts, timeout, and rate limiting. It featured `process_epos_queue_simple()` to identify and process pending contacts, checking for their existence in EPOS before performing an update or create operation via `oEpos->updateContactViaRFD()` or `oEpos->sendContactViaRFD()`. It updated the contact's sync status and attempt count. A more "advanced" queueing method using a separate table was present but commented out.
    *   **Refinement (10/29/2025, 9:51:15 AM)**: The `TIMEOUT_SECONDS` configuration constant and its usage to set a timeout on the `Epos` object were removed.
    *   **Simplification (10/29/2025, 9:53:58 AM)**: The commented-out `process_epos_queue_advanced()` function was completely removed, indicating a decision to proceed solely with the simpler queueing mechanism using contact table flags.
    *   **Minor Change (10/29/2025, 10:18:14 AM)**: The `require_once('site_globals.php');` statement was changed to `require('site_globals.php');`.
    *   **Potential Security / Access Change (10/29/2025, 10:27:00 AM)**: The initial code block preventing the script from being run via a web browser (unless `?allow_web=1` was present) was commented out, potentially exposing the cron job to direct web access. The `chdir(__DIR__);` statement was also commented out at this time, which might affect relative path resolution.
    *   **Further Modification (10/29/2025, 10:27:33 AM)**: The `chdir(__DIR__);` line remained commented out, while the web access prevention block remained disabled.

*   **`scripts\cron_epos_sync.php`**: This file appears to be a relocation of the EPOS sync worker.
    *   **Relocation and Path Adjustment (10/29/2025, 10:12:30 AM)**: The `cron_epos_sync.php` script was moved from the `site\` directory to `scripts\`. Correspondingly, the `require_once` path for `site_globals.php` was updated from `site_globals.php` to `site/site_globals.php` to reflect the new relative location. The content matches the state of `site\cron_epos_sync.php` after the `process_epos_queue_advanced()` function removal.
    *   **Path Inaccuracy (10/29/2025, 10:12:51 AM)**: The `require_once` path was changed to `/site/site_globals.php`, making it an absolute path from the root.
    *   **Configuration Issue (10/29/2025, 10:12:59 AM)**: The `require_once` statement for `site_globals.php` was commented out entirely, indicating a potential issue with resolving the path to critical global settings.

**Patterns and Recurring Elements:**

*   **EPOS Synchronization:** The dominant theme is the implementation and refinement of an EPOS synchronization mechanism for contact data. This involves identifying pending contacts, attempting to synchronize them (create or update), and tracking sync status and attempts.
*   **Queueing Strategy:** An initial consideration for a dedicated queue table (`epos_sync_queue`) was quickly abandoned in favor of using flags directly within the `contact` table to manage pending syncs.
*   **Logging and Error Handling:** Both files use `site_create_notification` and `log_sync`/`error_log` for feedback and debugging, and include basic exception handling for EPOS calls.
*   **File Organization:** A `cron_epos_sync.php` file was introduced, and later relocated to a `scripts\` directory, highlighting an evolution in project structure for background tasks.
*   **Dependency Pathing:** Changes to the `require`/`require_once` statements and the `chdir(__DIR__)` line in `cron_epos_sync.php` suggest ongoing adjustments and potential issues with how dependencies are loaded from different script locations.
*   **Web Access Management:** The `cron_epos_sync.php` script initially enforced command-line execution but later had this restriction commented out, which could have implications for security or intended execution environment.

## 11:29:12 AM
The log details changes across two PHP files: `contact.php` and `cron_epos_sync.php`, both related to contact management and integration with an EPOS (Electronic Point of Sale) system.

**File-Specific Updates:**

*   **`c:\Users\Dennis\Documents\projects\rfdregister\site\contact.php`** (Changes observed between 10/29/2025, 9:44:05 AM and 10/29/2025, 10:03:17 AM):
    *   **EPOS Synchronization Initiation:** The most significant change was the introduction of a `queue_epos_sync` function (around 9:47:35 AM). This function is responsible for marking a contact for synchronization by updating `contact_epos_sync_status` to 'pending' and resetting `contact_epos_sync_attempts` in the `contact` table.
    *   **Design Choice for EPOS Queueing:** Initially, a commented-out section in `queue_epos_sync` suggested using a dedicated `epos_sync_queue` table, but this was removed shortly after (9:47:45 AM), indicating a decision to proceed with using flags within the existing `contact` table for EPOS sync management.
    *   **Minor Code Reordering:** The `queue_epos_sync` function itself was repositioned within the file (10:03:17 AM), but its core logic remained unchanged.
    *   The file manages contact creation/editing workflows, often redirecting users to gun or ammo transaction pages after contact operations, accompanied by notification messages. It defines various input fields for contact details.

*   **`c:\Users\Dennis\Documents\projects\rfdregister\site\cron_epos_sync.php` (and temporary path `scripts\cron_epos_sync.php`)** (Changes observed between 10/29/2025, 9:50:30 AM and 10/29/2025, 11:12:45 AM):
    *   **Initial EPOS Background Worker (9:50:30 AM):** A new script was created to handle background EPOS synchronization. It defines configurations like `MAX_BATCH_SIZE`, `MAX_ATTEMPTS`, `TIMEOUT_SECONDS`, and `RATE_LIMIT_DELAY`. It retrieves clients with EPOS enabled and processes contacts marked for sync, checking if they exist in EPOS and then either creating or updating them. It includes robust logging and retry mechanisms.
    *   **Function Removal (9:53:58 AM):** An alternative, more "advanced" queue processing function (`process_epos_queue_advanced`) was removed, streamlining the script to use the simpler `process_epos_queue_simple` approach.
    *   **File Relocation and Path Adjustments (10:12:30 AM - 10:12:59 AM):** The file was temporarily moved from `site\` to `scripts\`. This necessitated changes to the `require_once` path for `site_globals.php`. There were also temporary commenting/uncommenting of `chdir(__DIR__)` and the `site_globals.php` include. The file later returned to `site\` (10:15:41 AM).
    *   **CLI Environment Mocking (10:36:24 AM):** A significant addition was a "MOCK WEB ENVIRONMENT FOR CLI" block. This sets various `$_SERVER` superglobal variables to simulate a web request, crucial for `site_globals.php` which expects these to be present even when run via CLI.
    *   **PHP/XDebug Compatibility (10:36:55 AM - 10:41:46 AM):** Fixes were introduced for compatibility with newer PHP versions (mocking `get_magic_quotes_gpc`) and for environments without XDebug installed (mocking `xdebug_start_trace`). Output buffering was also explicitly cleaned.
    *   **Refactoring to Minimal Standalone (10:47:54 AM):** The script was extensively refactored to be a "MINIMAL STANDALONE" version. This involved explicitly setting error reporting, defining `APPLICATION_PATH`, directly including `site_data.php` (for DB credentials) and `egc/egc_data_mysqli.php` (for DB functions), implementing a custom autoloader, and mocking `site_client_has_option` locally. Database credentials were hardcoded in this version (initially 'db', 'guntrader', 'secret', then 'legacy-guntrader-db-1', 'root', 'root' at 10:48:51 AM). Error suppression (`@`) was added to EPOS interaction calls.
    *   **Minor CLI Mock Update (11:10:47 AM):** The `$_SERVER['SERVER_NAME']` in the CLI mock was updated to include a port (`localhost:8082`).
    *   **Breaking Change (11:11:42 AM):** The `require_once('site_globals.php');` statement was moved to the very top, *before* the CLI mock environment and compatibility fixes. This placement would likely negate the "minimal standalone" design by executing `site_globals.php` without the necessary mocked environment.

**Patterns and Recurring Elements:**

*   **EPOS Integration Focus:** Both files are heavily concerned with EPOS integration, with `contact.php` triggering syncs and `cron_epos_sync.php` executing them.
*   **Database Interaction:** Both scripts utilize `egc_ss_query` for database operations, suggesting a common database access layer.
*   **Client-Specific Options:** The `client_id` and `client_options` (specifically checking for the `:EPOS:` flag) are used to enable EPOS functionality on a per-client basis.
*   **CLI Environment Robustness:** The `cron_epos_sync.php` file shows a strong pattern of attempting to make a server-side PHP script function reliably in a command-line environment, including simulating web server variables and addressing PHP version compatibility issues.
*   **Logging and Error Handling:** `log_sync` function and `try-catch` blocks are consistently used in `cron_epos_sync.php` for tracking execution and managing errors.
*   **Configuration Constants:** `MAX_BATCH_SIZE`, `MAX_ATTEMPTS`, and `RATE_LIMIT_DELAY` are frequently defined and adjusted in the cron script, indicating a configurable background process.